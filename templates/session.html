<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore Your Chakras | Inner Universe</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        body, html { height: 100%; margin: 0; padding: 0; }
        .chakra-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: url('/static/img/img2.webp') no-repeat center center fixed; background-size: cover; z-index: 0; filter: brightness(0.8) blur(1px); }
        .overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.3); z-index: 1; }
        .content { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; }
        .session-header { color: #fff; font-size: 2rem; font-weight: bold; margin-top: 2rem; margin-bottom: 0.5rem; text-shadow: 0 2px 16px #000; }
        .step-indicator { color: #fff; font-size: 1.1rem; margin-bottom: 1.5rem; text-shadow: 0 1px 8px #000; }
        .chakra-selector { display: flex; flex-direction: column; align-items: center; margin-bottom: 2rem; }
        .chakra-list { display: flex; flex-direction: column; gap: 0.7rem; }
        .chakra-item { display: flex; align-items: center; gap: 1rem; padding: 0.7rem 1.5rem; border-radius: 12px; cursor: pointer; background: rgba(255,255,255,0.08); border: 2px solid transparent; transition: background 0.2s, border 0.2s; min-width: 220px; }
        .chakra-item.selected, .chakra-item:focus { background: rgba(255,255,255,0.18); border: 2px solid #fff; }
        .chakra-symbol { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; }
        .chakra-name { color: #fff; font-size: 1.1rem; font-weight: 500; text-shadow: 0 1px 8px #000; }
        .chakra-color-root { background: #e53935; } .chakra-color-sacral { background: #ff9800; } .chakra-color-plexus { background: #fbc02d; } .chakra-color-heart { background: #43a047; } .chakra-color-throat { background: #1e88e5; } .chakra-color-third { background: #8e24aa; } .chakra-color-crown { background: #d81b60; }
        .step-panel { background: rgba(30, 30, 60, 0.7); border-radius: 18px; box-shadow: 0 8px 32px rgba(123,47,242,0.15); padding: 1.5rem 2rem; margin-bottom: 2rem; min-width: 520px; max-width: 600px; display: flex; flex-direction: column; align-items: center; }
        .step-btns { display: flex; gap: 1.5rem; margin: 1.2rem 0; }
        .step-btn { padding: 0.7rem 2rem; font-size: 1.1rem; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; background: #7b2ff2; color: #fff; transition: background 0.2s; }
        .step-btn:hover { background: #4a90e2; }
        .demo-gesture { display: flex; flex-direction: column; align-items: center; margin-bottom: 1.2rem; }
        .demo-anim { width: 250px; height: 250px; margin-bottom: 1rem; background: rgba(255,255,255,0.08); border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .practice-area { position: relative; width: 480px; height: 360px; margin-bottom: 1.2rem; }
        #practice-cam { width: 480px; height: 360px; border-radius: 18px; background: #222; }
        .hand-outline { position: absolute; right: 10px; bottom: 10px; width: 80px; opacity: 0.5; }
        .feedback { color: #fff; font-size: 1.2rem; margin-top: 1.2rem; text-shadow: 0 1px 8px #000; min-height: 2.2em; text-align: center; }
        .glow { box-shadow: 0 0 32px 8px #fff, 0 0 80px 32px #fff3; }
        .back-btn { margin-top: 1.5rem; background: none; color: #fff; border: 2px solid #fff; border-radius: 8px; padding: 0.5rem 1.5rem; font-size: 1rem; cursor: pointer; transition: background 0.2s, color 0.2s; }
        .back-btn:hover { background: #fff; color: #7b2ff2; }
    </style>
</head>
<body>
    <div class="chakra-bg"></div>
    <div class="overlay"></div>
    <div class="content">
        <div class="session-header">Explore Your Chakras</div>
        <div class="step-indicator" id="step-indicator">Step 1 of 3</div>
        <div class="step-panel" id="step-panel">
            <!-- Step content will be injected here -->
        </div>
        <button class="back-btn" id="back-btn" style="display:none;">&#8592; Choose another chakra</button>
    </div>
    <script>
    // Chakra data
    const chakras = [
        { name: 'Root', color: 'chakra-color-root', symbol: '\u25CF', demo: 'Root: ring finger tip touching thumb tip', feedback: 'grounding & stability.' },
        { name: 'Sacral', color: 'chakra-color-sacral', symbol: '\u25CF', demo: 'Sacral: little finger tip touching thumb tip', feedback: 'creativity & pleasure.' },
        { name: 'Solar Plexus', color: 'chakra-color-plexus', symbol: '\u25CF', demo: 'Solar Plexus: ring finger touching base of thumb', feedback: 'center of confidence.' },
        { name: 'Heart', color: 'chakra-color-heart', symbol: '\u25CF', demo: 'Heart: both palms pressed together', feedback: 'love & compassion.' },
        { name: 'Throat', color: 'chakra-color-throat', symbol: '\u25CF', demo: 'Throat: middle finger tip touching thumb tip', feedback: 'communication & truth.' },
        { name: 'Third Eye', color: 'chakra-color-third', symbol: '\u25CF', demo: 'Third Eye: fingertips touching in dome shape', feedback: 'intuition & insight.' },
        { name: 'Crown', color: 'chakra-color-crown', symbol: '\u25CF', demo: 'Crown: index finger tip touching thumb tip', feedback: 'spiritual connection.' }
    ];
    let selectedChakra = null;
    let step = 1;
    let practiceActive = false;

    const stepPanel = document.getElementById('step-panel');
    const stepIndicator = document.getElementById('step-indicator');
    const backBtn = document.getElementById('back-btn');

    // Mood data and mapping
    const moods = [
        { name: 'Calm', chakra: 'Heart', desired: 'centered and peaceful' },
        { name: 'Anxious', chakra: 'Root', desired: 'grounded and secure' },
        { name: 'Tired', chakra: 'Solar Plexus', desired: 'energized and confident' },
        { name: 'Distracted', chakra: 'Third Eye', desired: 'focused and clear' },
        { name: 'Unmotivated', chakra: 'Sacral', desired: 'creative and inspired' },
        { name: 'Stressed', chakra: 'Throat', desired: 'calm and expressive' },
        { name: 'Energetic', chakra: 'Crown', desired: 'spiritually connected' },
        { name: 'Focused', chakra: 'Third Eye', desired: 'insightful and attentive' },
        { name: 'Let me choose manually', chakra: null, desired: null }
    ];
    let selectedMood = null;
    let moodStep = 1; // 1: mood select, 2: recommend, 3: chakra list/session

    function renderMoodSelector() {
        moodStep = 1;
        selectedMood = null;
        stepIndicator.textContent = '';
        backBtn.style.display = 'none';
        stepPanel.innerHTML = `
            <div class="chakra-selector">
                <div class="feedback" style="margin-bottom:1.2rem;font-size:1.3rem;">How are you feeling right now?<br><span style='font-size:1.1rem;'>Please select your current mood:</span></div>
                <div class="chakra-list" id="mood-list" style="gap:1.1rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));max-width:520px;">
                    ${moods.map((m, i) => `
                        <div class="chakra-item" tabindex="0" data-idx="${i}" style="min-width:unset;justify-content:center;text-align:center;font-size:1.1rem;box-shadow:0 2px 12px #0001;">
                            <span class="chakra-name">${m.name}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        document.querySelectorAll('.chakra-item').forEach(item => {
            item.onclick = () => { selectedMood = parseInt(item.dataset.idx); handleMoodSelection(); };
            item.onkeydown = (e) => { if (e.key === 'Enter') { selectedMood = parseInt(item.dataset.idx); handleMoodSelection(); } };
        });
    }

    function handleMoodSelection() {
        const mood = moods[selectedMood];
        if (mood.chakra) {
            renderMoodRecommendation(mood);
        } else {
            renderChakraSelector();
        }
    }

    function renderMoodRecommendation(mood) {
        moodStep = 2;
        stepIndicator.textContent = '';
        backBtn.style.display = 'none';
        // Find chakra index
        const chakraIdx = chakras.findIndex(c => c.name.toLowerCase() === mood.chakra.toLowerCase());
        const chakra = chakras[chakraIdx];
        stepPanel.innerHTML = `
            <div class="chakra-selector">
                <div class="feedback" style="margin-bottom:1.2rem;font-size:1.2rem;">Based on your mood, we recommend practicing the <span style="font-weight:bold;color:#ffd700;">${chakra.name} Chakra</span> to help you feel more <span style="color:#7bffb3;">${mood.desired}</span>.</div>
                <div class="chakra-list" style="gap:0.7rem;justify-content:center;">
                    <div class="chakra-item selected" style="min-width:240px;justify-content:center;box-shadow:0 0 16px #fff7;">
                        <span class="chakra-symbol ${chakra.color}">${chakra.symbol}</span>
                        <span class="chakra-name">${chakra.name}</span>
                    </div>
                </div>
                <div style="display:flex;gap:1.5rem;margin-top:1.5rem;justify-content:center;">
                    <button class="step-btn" id="start-recommended-btn">Start Session</button>
                    <button class="step-btn" id="back-to-mood-btn" style="background:#fff;color:#7b2ff2;">Back to Mood Selection</button>
                </div>
            </div>
        `;
        document.getElementById('start-recommended-btn').onclick = () => {
            selectedChakra = chakraIdx;
            renderDemoOrPractice();
        };
        document.getElementById('back-to-mood-btn').onclick = () => {
            renderMoodSelector();
        };
    }

    // Update renderChakraSelector to allow back navigation to mood selection
    function renderChakraSelector() {
        moodStep = 3;
        stepIndicator.textContent = '';
        backBtn.style.display = 'inline-block';
        stepPanel.innerHTML = `
            <div class="chakra-selector">
                <div class="feedback" style="margin-bottom:1rem;">Select the chakra you want to practice:</div>
                <div class="chakra-list" id="chakra-list">
                    ${chakras.map((c, i) => `
                        <div class="chakra-item" tabindex="0" data-idx="${i}">
                            <span class="chakra-symbol ${c.color}">${c.symbol}</span>
                            <span class="chakra-name">${c.name}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        document.querySelectorAll('.chakra-item').forEach(item => {
            item.onclick = () => { selectedChakra = parseInt(item.dataset.idx); renderDemoOrPractice(); };
            item.onkeydown = (e) => { if (e.key === 'Enter') { selectedChakra = parseInt(item.dataset.idx); renderDemoOrPractice(); } };
        });
    }

    // Update backBtn logic to always go to mood selection
    backBtn.onclick = () => {
        stopPracticeCamera();
        renderMoodSelector();
    };

    // --- MediaPipe Hands integration for practice ---
    let practiceStream = null;
    let hands = null;
    let camera = null;
    let gestureDetected = false;
    let handPresent = false;
    let frameCount = 0; // For frame skipping to reduce lag

    function stopPracticeCamera() {
        if (practiceStream) {
            practiceStream.getTracks().forEach(track => track.stop());
            practiceStream = null;
        }
        if (camera && camera.stop) camera.stop();
        camera = null;
        if (hands && hands.close) hands.close();
        hands = null;
        gestureDetected = false;
        handPresent = false;
        frameCount = 0;
        // Clear overlays and feedback if present
        const canvas = document.getElementById('practice-canvas');
        if (canvas) { const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); }
        const feedback = document.getElementById('practice-feedback');
        if (feedback) feedback.textContent = '';
    }

    function renderDemoOrPractice() {
        stepIndicator.textContent = '';
        backBtn.textContent = 'Back to Mood Selection';
        backBtn.style.display = 'inline-block';
        const c = chakras[selectedChakra];
        stepPanel.innerHTML = `
            <div class="feedback" style="margin-bottom:1.2rem;">Would you like to see a demo of the gesture, or start practicing directly?</div>
            <div class="step-btns">
                <button class="step-btn" id="show-demo-btn">Show Demo</button>
                <button class="step-btn" id="start-practice-btn">Start Practice</button>
            </div>
        `;
        document.getElementById('show-demo-btn').onclick = renderDemo;
        document.getElementById('start-practice-btn').onclick = renderPractice;
    }

    function renderDemo() {
        stepIndicator.textContent = '';
        backBtn.style.display = 'inline-block';
        const c = chakras[selectedChakra];
        // Map chakra names to actual GIF filenames
        const gifMap = {
            'root': 'rootchakra-gif.gif',
            'sacral': 'sacralchakra-gif.gif',
            'solarplexus': 'solarplexus-gif.gif',
            'heart': 'heartchakra.jpg',
            'throat': 'throatchakra-gif.gif',
            'thirdeye': 'thirdeyechakra.jpg',
            'crown': 'crown-gif.gif'
        };
        const gifName = gifMap[c.name.toLowerCase().replace(/\s/g, '')] || 'rootchakra-gif.gif'; // fallback to root
        
        // Custom demo messages for each chakra
        const demoMessages = {
            'root': 'Follow along with this gesture to activate your Root Chakra — a symbol of balance and connection to the earth. When you\'re ready, click \'Start Practicing\' to try it yourself!',
            'sacral': 'Follow along with this gesture to activate your Sacral Chakra — a symbol of creativity and pleasure. When you\'re ready, click \'Start Practicing\' to try it yourself!',
            'solarplexus': 'Follow along with this gesture to activate your Solar Plexus Chakra — a symbol of confidence and personal power. When you\'re ready, click \'Start Practicing\' to try it yourself!',
            'heart': 'Follow along with this gesture to activate your Heart Chakra — a symbol of love and compassion. When you\'re ready, click \'Start Practicing\' to try it yourself!',
            'throat': 'Follow along with this gesture to activate your Throat Chakra — a symbol of communication and truth. When you\'re ready, click \'Start Practicing\' to try it yourself!',
            'thirdeye': 'Follow along with this gesture to activate your Third Eye Chakra — a symbol of intuition and insight. When you\'re ready, click \'Start Practicing\' to try it yourself!',
            'crown': 'Follow along with this gesture to activate your Crown Chakra — a symbol of spiritual connection. When you\'re ready, click \'Start Practicing\' to try it yourself!'
        };
        
        const demoMessage = demoMessages[c.name.toLowerCase().replace(/\s/g, '')] || demoMessages['root'];
        
        stepPanel.innerHTML = `
            <div class="demo-gesture">
                <div class="demo-anim" id="demo-anim">
                    <img id="gesture-gif" src="/static/img/${gifName}" alt="${c.name} gesture demo" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" loop autoplay />
                    <div id="demo-fallback" style="display:none;color:#fff;text-align:center;margin-top:0.5rem;">Demo unavailable — please proceed to practice.</div>
                </div>
                <div class="feedback" style="margin-top:0.5rem;">${demoMessage}</div>
                <button class="step-btn" id="demo-to-practice-btn" style="margin-top:1.2rem;">Start Practicing</button>
            </div>
        `;
        // GIF fallback logic
        const gifImg = document.getElementById('gesture-gif');
        gifImg.onerror = function() {
            gifImg.style.display = 'none';
            document.getElementById('demo-fallback').style.display = 'block';
        };
        document.getElementById('demo-to-practice-btn').onclick = renderPractice;
    }

    function renderPractice() {
        stepIndicator.textContent = '';
        backBtn.style.display = 'inline-block';
        const c = chakras[selectedChakra];
        stepPanel.innerHTML = `
            <div class="practice-area">
                <video id="practice-cam" autoplay playsinline muted></video>
                <canvas id="practice-canvas" width="480" height="360" style="position:absolute;left:0;top:0;pointer-events:none;"></canvas>
            </div>
            <div class="feedback" id="practice-feedback">Waiting for your gesture…</div>
        `;
        setupPracticeCamera();
    }

    async function setupPracticeCamera() {
        stopPracticeCamera();
        const video = document.getElementById('practice-cam');
        const canvas = document.getElementById('practice-canvas');
        const ctx = canvas.getContext('2d');
        const feedback = document.getElementById('practice-feedback');
        gestureDetected = false;
        handPresent = false;
        frameCount = 0;
        
        // Get camera with optimized settings
        practiceStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 640 },
                height: { ideal: 480 },
                frameRate: { ideal: 30, max: 30 }
            } 
        });
        video.srcObject = practiceStream;
        await video.play();
        
        // Load MediaPipe with optimized settings for better performance
        hands = new window.Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });
        // Configure MediaPipe to detect up to 2 hands for Heart and Third Eye chakras
        const maxHands = (chakras[selectedChakra].name.toLowerCase() === 'heart' || 
                         chakras[selectedChakra].name.toLowerCase() === 'third eye') ? 2 : 1;
        
        hands.setOptions({
            maxNumHands: maxHands,
            modelComplexity: 0, // Use lighter model for better performance
            minDetectionConfidence: 0.5, // Lower threshold for faster detection
            minTrackingConfidence: 0.5
        });
        
        hands.onResults((results) => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                handPresent = true;
                // Draw landmarks for all detected hands
                results.multiHandLandmarks.forEach((handLandmarks, index) => {
                    const color = index === 0 ? '#0ff' : '#ff0'; // Different colors for each hand
                    drawConnectors(ctx, handLandmarks, window.HAND_CONNECTIONS, { color: color, lineWidth: 2 });
                    drawLandmarks(ctx, handLandmarks, { color: '#fff', lineWidth: 1 });
                });
                // Gesture detection for all chakras
                if (detectChakraGesture(results, chakras[selectedChakra].name)) {
                    if (!gestureDetected) {
                        gestureDetected = true;
                        feedback.innerHTML = `✅ You performed the ${chakras[selectedChakra].name} Chakra gesture correctly — ${chakras[selectedChakra].feedback}`;
                        // Optionally play sound
                        // new Audio('/static/sounds/chime.mp3').play();
                    }
                } else {
                    gestureDetected = false;
                    feedback.innerHTML = `Waiting for your gesture…`;
                }
            } else {
                // No hand detected: clear overlays and feedback
                if (handPresent || gestureDetected) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    feedback.innerHTML = `Waiting for your gesture…`;
                    gestureDetected = false;
                    handPresent = false;
                }
            }
        });
        
        // Camera utils with frame skipping to reduce lag
        camera = new window.Camera(video, {
            onFrame: async () => {
                if (hands) {
                    frameCount++;
                    // Process every frame for better detection (removed frame skipping)
                    await hands.send({ image: video });
                }
            },
            width: 480,
            height: 360
        });
        camera.start();
    }

    // --- Gesture detection for all Chakras ---
    function detectRootGesture(landmarks) {
        // Root Chakra — Prithvi Mudra: Ring finger tip touches thumb tip
        function dist(a, b) {
            return Math.sqrt((a.x-b.x)**2 + (a.y-b.y)**2);
        }
        
        const thumbTip = landmarks[4];
        const ringTip = landmarks[16]; // Ring finger tip
        const indexTip = landmarks[8];
        const middleTip = landmarks[12];
        const pinkyTip = landmarks[20];
        
        // Ring finger tip close to thumb tip (Root Chakra gesture)
        const ringThumbClose = dist(ringTip, thumbTip) < 0.1;
        
        // Other fingers straight and separated
        const indexStraight = indexTip.y < landmarks[6].y + 0.05;
        const middleStraight = middleTip.y < landmarks[10].y + 0.05;
        const pinkyStraight = pinkyTip.y < landmarks[18].y + 0.05;
        
        return ringThumbClose && indexStraight && middleStraight && pinkyStraight;
    }

    function detectSacralGesture(landmarks) {
        // Sacral Chakra — Varun Mudra: Little finger tip touches thumb tip
        function dist(a, b) {
            return Math.sqrt((a.x-b.x)**2 + (a.y-b.y)**2);
        }
        
        const thumbTip = landmarks[4];
        const pinkyTip = landmarks[20]; // Little finger tip
        const indexTip = landmarks[8];
        const middleTip = landmarks[12];
        const ringTip = landmarks[16];
        
        // Little finger tip close to thumb tip (Sacral Chakra gesture)
        const pinkyThumbClose = dist(pinkyTip, thumbTip) < 0.1;
        
        // Other fingers straight and separated
        const indexStraight = indexTip.y < landmarks[6].y + 0.05;
        const middleStraight = middleTip.y < landmarks[10].y + 0.05;
        const ringStraight = ringTip.y < landmarks[14].y + 0.05;
        
        return pinkyThumbClose && indexStraight && middleStraight && ringStraight;
    }

    function detectSolarPlexusGesture(landmarks) {
        // Solar Plexus Chakra — Surya Mudra: Ring finger touches base of thumb
        function dist(a, b) {
            return Math.sqrt((a.x-b.x)**2 + (a.y-b.y)**2);
        }
        
        const thumbTip = landmarks[4];
        const thumbBase = landmarks[2]; // Base of thumb
        const ringTip = landmarks[16];
        const indexTip = landmarks[8];
        const middleTip = landmarks[12];
        const pinkyTip = landmarks[20];
        
        // Ring finger tip close to base of thumb (not tip)
        const ringThumbBaseClose = dist(ringTip, thumbBase) < 0.12;
        
        // Thumb should be extended over the ring finger
        const thumbExtended = thumbTip.y < thumbBase.y + 0.05;
        
        // Other fingers straight and relaxed
        const indexStraight = indexTip.y < landmarks[6].y + 0.05;
        const middleStraight = middleTip.y < landmarks[10].y + 0.05;
        const pinkyStraight = pinkyTip.y < landmarks[18].y + 0.05;
        
        return ringThumbBaseClose && thumbExtended && indexStraight && middleStraight && pinkyStraight;
    }

    function detectHeartGesture(results) {
        // Heart Chakra — Anjali Mudra: Both palms pressed together
        if (!results.multiHandLandmarks || results.multiHandLandmarks.length < 2) {
            return false;
        }
        
        function dist(a, b) {
            return Math.sqrt((a.x-b.x)**2 + (a.y-b.y)**2);
        }
        
        const hand1 = results.multiHandLandmarks[0];
        const hand2 = results.multiHandLandmarks[1];
        
        // Check if palms are close together (pressed together)
        const palm1Center = {
            x: (hand1[0].x + hand1[5].x + hand1[17].x) / 3,
            y: (hand1[0].y + hand1[5].y + hand1[17].y) / 3
        };
        const palm2Center = {
            x: (hand2[0].x + hand2[5].x + hand2[17].x) / 3,
            y: (hand2[0].y + hand2[5].y + hand2[17].y) / 3
        };
        
        const palmsClose = dist(palm1Center, palm2Center) < 0.15;
        
        // Check if corresponding fingertips are touching
        const indexTipsClose = dist(hand1[8], hand2[8]) < 0.1;
        const middleTipsClose = dist(hand1[12], hand2[12]) < 0.1;
        const ringTipsClose = dist(hand1[16], hand2[16]) < 0.1;
        const pinkyTipsClose = dist(hand1[20], hand2[20]) < 0.1;
        
        return palmsClose && indexTipsClose && middleTipsClose && ringTipsClose && pinkyTipsClose;
    }

    function detectThroatGesture(landmarks) {
        // Throat Chakra — Akash Mudra: Middle finger tip touches thumb tip
        function dist(a, b) {
            return Math.sqrt((a.x-b.x)**2 + (a.y-b.y)**2);
        }
        
        const thumbTip = landmarks[4];
        const middleTip = landmarks[12]; // Middle finger tip
        const indexTip = landmarks[8];
        const ringTip = landmarks[16];
        const pinkyTip = landmarks[20];
        
        // Middle finger tip close to thumb tip (Throat Chakra gesture)
        const middleThumbClose = dist(middleTip, thumbTip) < 0.1;
        
        // Other fingers straight and separated
        const indexStraight = indexTip.y < landmarks[6].y + 0.05;
        const ringStraight = ringTip.y < landmarks[14].y + 0.05;
        const pinkyStraight = pinkyTip.y < landmarks[18].y + 0.05;
        
        return middleThumbClose && indexStraight && ringStraight && pinkyStraight;
    }

    function detectThirdEyeGesture(results) {
        // Third Eye Chakra — Hakini Mudra: Index, middle, and thumb fingertips of both hands touching
        if (!results.multiHandLandmarks || results.multiHandLandmarks.length < 2) {
            return false;
        }
        function dist(a, b) {
            return Math.sqrt((a.x-b.x)**2 + (a.y-b.y)**2);
        }
        const hand1 = results.multiHandLandmarks[0];
        const hand2 = results.multiHandLandmarks[1];
        // Require index, middle, and thumb fingertips to be touching (much tighter threshold)
        const indexTipsClose = dist(hand1[8], hand2[8]) < 0.08;
        const middleTipsClose = dist(hand1[12], hand2[12]) < 0.08;
        const thumbTipsClose = dist(hand1[4], hand2[4]) < 0.08;
        // All three fingertips must be touching
        return indexTipsClose && middleTipsClose && thumbTipsClose;
    }

    function detectCrownGesture(landmarks) {
        // Crown Chakra — Gyan Mudra: Index finger tip touches thumb tip
        function dist(a, b) {
            return Math.sqrt((a.x-b.x)**2 + (a.y-b.y)**2);
        }
        
        const thumbTip = landmarks[4];
        const indexTip = landmarks[8]; // Index finger tip
        const middleTip = landmarks[12];
        const ringTip = landmarks[16];
        const pinkyTip = landmarks[20];
        
        // Index finger tip close to thumb tip (Crown Chakra gesture)
        const indexThumbClose = dist(indexTip, thumbTip) < 0.1;
        
        // Other fingers straight and relaxed
        const middleStraight = middleTip.y < landmarks[10].y + 0.05;
        const ringStraight = ringTip.y < landmarks[14].y + 0.05;
        const pinkyStraight = pinkyTip.y < landmarks[18].y + 0.05;
        
        return indexThumbClose && middleStraight && ringStraight && pinkyStraight;
    }

    // Main gesture detection function that calls the appropriate chakra detection
    function detectChakraGesture(results, chakraName) {
        // For single hand gestures, use the first hand
        if (chakraName.toLowerCase() === 'heart' || chakraName.toLowerCase() === 'third eye') {
            // Two-hand gestures
            switch(chakraName.toLowerCase()) {
                case 'heart':
                    return detectHeartGesture(results);
                case 'third eye':
                    return detectThirdEyeGesture(results);
                default:
                    return false;
            }
        } else {
            // Single hand gestures
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                return false;
            }
            const landmarks = results.multiHandLandmarks[0];
            
            switch(chakraName.toLowerCase()) {
                case 'root':
                    return detectRootGesture(landmarks);
                case 'sacral':
                    return detectSacralGesture(landmarks);
                case 'solar plexus':
                    return detectSolarPlexusGesture(landmarks);
                case 'throat':
                    return detectThroatGesture(landmarks);
                case 'crown':
                    return detectCrownGesture(landmarks);
                default:
                    return false;
            }
        }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', stopPracticeCamera);

    // Initial render: show welcome page
    renderMoodSelector();
    // Load MediaPipe drawing utils
    const script1 = document.createElement('script');
    script1.src = 'https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js';
    document.body.appendChild(script1);
    const script2 = document.createElement('script');
    script2.src = 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js';
    document.body.appendChild(script2);
    const script3 = document.createElement('script');
    script3.src = 'https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js';
    document.body.appendChild(script3);
    </script>
</body>
</html> 